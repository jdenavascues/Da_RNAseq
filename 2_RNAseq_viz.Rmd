---
title: "Visualisation of DESeq2 results"
description: "DEG analysis based on DESeq2 and GSEA"
principal investigator: "Joaquín de Navascués"
researcher: "Aleix Puig, modified by Joaquín de Navascués"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: readable
    df_print: paged
---
```{r set-publication-theme, echo=FALSE, cache=FALSE}
ggplot2::theme_set(ggpubr::theme_pubr(base_size=10))
```

```{r setup, echo = FALSE, cache = FALSE}
knitr::opts_chunk$set(dev = c('png', 'cairo_pdf'), 
                      fig.align = 'center', fig.height = 5, fig.width = 8.5, 
                      pdf.options(encoding = "ISOLatin9.enc"),
                      fig.path='integration/figures/', warning=FALSE, message=FALSE)
```

# 0 Getting ready

We have 4 different conditions expressed with the _esg-Gal4_ driver:

* in batch one:
  
  * _UAS-daughterless_ (_da_)
  * _UAS-da^RNAi^_ (TRiP-line, either JF02488 or JF02092)
  * and their control

* in batch two:

  * _UAS-da:da_
  * _UAS-scute_
  * and their control

We have their "transcripts per million" (tpm) in different RDS files.

```{r, include=FALSE}
library(ggplot2)
library(ggthemes) # italics in the figures
library(ggtext) # italics in the figures
library(pheatmap)        # to plot heatmap
library(tibble)
library(here); setwd(here())

#devtools::install_github("thomasp85/scico")
library(scico)
scico_palette_show(palettes = c("broc", "cork", "vik",
                                "lisbon", "tofino", "berlin",
                                "batlow", "roma"))
```

# 1 Principal Components Analysis

## 1.1. PCA of the batches separately

### 1.1.1 _da_ overexpression and knock-down

Include the whole dataset (as opposed to only the genes with significant DE).
```{r}
# get the data (fresh session)
targetsB1 <- read.table("resources/targets_daoekd.txt", header=TRUE, sep="\t")
tpmNormalisedCountsB1 <- readRDS('daoekd_counts.RDS')
# remove all rows that have no variance
tpmNormalisedCountsB1_pca <- tpmNormalisedCountsB1[
  rowSums(tpmNormalisedCountsB1[-1] != tpmNormalisedCountsB1[[2]], na.rm = TRUE) != 0,
  ]
```

### PCA object
```{r}
pca <- prcomp(t(tpmNormalisedCountsB1_pca), center=TRUE, scale=TRUE)
scores <- data.frame(targetsB1$sampleID, pca$x[,1:2])
summary(pca)
```
### Create QC plot
```{r}
targetsB1$Condition[targetsB1$Condition=='DaOE'] <- '*esg>da*'
targetsB1$Condition[targetsB1$Condition=='DaKD'] <- '*esg>da^RNAi^*'
targetsB1$Condition[targetsB1$Condition=='Control'] <- '*esg>*'

ggplot(scores,
       aes(x = PC1, y = PC2, label=factor(targetsB1$sampleID), colour=factor(targetsB1$Condition) )
       ) +
  geom_point(size=3) + 
  geom_text(size=3, hjust=0.5, vjust=-1) +
  scale_colour_discrete(name="condition") +
  theme(legend.text=element_markdown(size=9))
```

### 1.1.2 _da:da_ and _scute_ overexpression

Include the whole dataset (as opposed to only the genes with significant DE).
```{r}
targetsB2 <- read.table("resources/targets_dadasc.txt", header=TRUE, sep="\t")
tpmNormalisedCountsB2 <- readRDS('dadasc_counts.RDS')
# remove all rows that have no variance
tpmNormalisedCountsB2_pca <- tpmNormalisedCountsB2[
  rowSums(tpmNormalisedCountsB2[-1] != tpmNormalisedCountsB2[[2]], na.rm = TRUE) != 0,
  ]
```

### PCA object
```{r}
pca <- prcomp(t(tpmNormalisedCountsB2_pca), center=TRUE, scale=TRUE)
scores <- data.frame(targetsB2$sampleID, pca$x[,1:2])
summary(pca)
```
### Create QC plot
```{r}
targetsB2$Condition[targetsB2$Condition=='DaDaOE'] <- '*esg>da:da*'
targetsB2$Condition[targetsB2$Condition=='ScOE'] <- '*esg>scute*'
targetsB2$Condition[targetsB2$Condition=='Control'] <- '*esg>*'

ggplot(scores,
       aes(x = PC1, y = PC2, label=factor(targetsB2$sampleID), colour=factor(targetsB2$Condition))
       ) +
  geom_point(size=3) + 
  geom_text(size=3, hjust=0.5, vjust=-1) +
  scale_colour_discrete(name="condition") +
  theme(legend.text=element_markdown(size=9))
```

## 1.2 PCA of all conditions

Include the whole dataset (as opposed to only the genes with significant DE).
```{r}
targets <- rbind(targetsB1, targetsB2)
common_genes <- intersect(rownames(tpmNormalisedCountsB1), rownames(tpmNormalisedCountsB2))
tpmNormalisedCounts <- cbind(tpmNormalisedCountsB1[common_genes,],
                             tpmNormalisedCountsB2[common_genes,])
# remove all rows that have no variance
tpmNormalisedCounts_pca <- tpmNormalisedCounts[
  rowSums(tpmNormalisedCounts[-1] != tpmNormalisedCounts[[2]], na.rm = TRUE) != 0,
  ]
# pca object
pca <- prcomp(t(tpmNormalisedCounts_pca), center=TRUE, scale=TRUE)
scores <- data.frame(targets$sampleID, pca$x[,1:2])
# plot
ggplot(scores,
       aes(x = PC1, y = PC2, label=factor(targets$sampleID), colour=factor(targets$Condition))
       ) +
  geom_point(size=3) + 
  geom_text(size=3, hjust=0.5, vjust=-1) +
  scale_colour_discrete(name="condition") +
  theme(legend.text=element_markdown(size=9))
```
###
### this needs to be addressed with some batch correction.
###

# 2 Heatmap

Get the TMP values from the previous script
```{r}
# Load tmp values
l <- list.files(getwd())
tmpdata <- l[unlist(lapply(l, grepl, pattern='_vs_'))]
sortedFinalData_named_KD   <- readRDS( tmpdata[unlist(lapply(tmpdata, grepl, pattern='KD'))] )
sortedFinalData_named_DaDa <- readRDS( tmpdata[unlist(lapply(tmpdata, grepl, pattern='DaDa'))] )
sortedFinalData_named_OE   <- readRDS( tmpdata[unlist(lapply(tmpdata, grepl, pattern='_DaOE'))] )
sortedFinalData_named_Sc   <- readRDS( tmpdata[unlist(lapply(tmpdata, grepl, pattern='Sc'))] )


```
Plot the tpm values

```{r}
relative_Significant_Genes <- sortedFinalData_named_KD %>% 
  filter(padj <= 0.01) %>%
  filter(log2FoldChange >= 1 | log2FoldChange <= -1) %>%
  dplyr::select(external_gene_name, starts_with("TPM")) %>%
  column_to_rownames(var="external_gene_name") %>%
  data.matrix()

#heatmap(heatmap_prep)
```

