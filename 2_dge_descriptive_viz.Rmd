---
title: "2. Visualisation of DESeq2 results"
description: "PCA and clustered heatmap"
principal investigator: "Joaquín de Navascués"
researchers: "Aleix Puig-Barbé, Joaquín de Navascués"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: readable
    df_print: paged
    css: doc.css
---
```{r setup, echo=FALSE, cache=FALSE}
ggplot2::theme_set(ggpubr::theme_pubr(base_size=10))
knitr::opts_chunk$set(dev = 'png', 
                      fig.align = 'center', fig.height = 7, fig.width = 8.5, 
                      pdf.options(encoding = "ISOLatin9.enc"),
                      fig.path='notebook_figs/', warning=FALSE, message=FALSE)
```


# 1 Preparation


**Libraries/utils:**
```{r libraries, warning=FALSE, message=FALSE}
if (!require("librarian")) install.packages("librarian")
librarian::shelf(
  # data
  tibble, DESeq2, stringr, purrr, plyr, dplyr, reshape2, santoku, DescTools, matrixStats, calibrate,
  # graphics
  ggplot2, ggthemes, ggtext, ggrepel, eulerr, RColorBrewer, cetcolor,
  # convenience
  here)

if(!exists("extract_regulated_sets", mode="function")) source("utils.R")
```

**Set working directory:**
```{r setwd}
if (Sys.getenv("RSTUDIO")==1) {
   # setwd to where the editor is, if the IDE is RStudio
  setwd( dirname(rstudioapi::getSourceEditorContext(id = NULL)$path) )
} else {
  # setwd to where the editor is in a general way - maybe less failsafe than the previous
  setwd(here::here())
  # the following checks that the latter went well, but assuming
  # that the user has not changed the name of the repo
  d <- str_split(getwd(),'/')[[1]][length(str_split(getwd(),'/')[[1]])]
  if (d != 'RNAseq-EmcDaSc-adult_midgut') { stop(
    paste0("Could not set working directory automatically to where this",
           " script resides.\nPlease do `setwd()` manually"))
    }
}
```

**To save images outside the repo (to reduce size):**
```{r define_dir2figs}
figdir <- paste0(c(head(str_split(getwd(),'/')[[1]],-1),
                   paste0(tail(str_split(getwd(),'/')[[1]],1), '_figures')),
                 collapse='/')
dir.create(figdir, showWarnings = FALSE)
```


# 2 RNAseq results visualisation: Principal Components Analysis


## 2.1 Load and check expression data


We have seen how batch correction is necessary to show a meaningful PCA. Of the different expression measures, vst-normalised data is the most reasonable to make comparisons across samples.
```{r load-vst}
targets <- readRDS('output/targets.RDS')
vsd <- readRDS('output/vst_pseudocounts_batchCorrected.RDS')
```

When performing PCA on RNAseq data, it is often useful to filter genes with very low variance across experimental conditions. To test whether this makes sense in our case:
```{r visualise-variance, warning=FALSE}
# get per-gene variance and mean expression
var_vsd <- rowVars(assay(vsd), rm.na=TRUE)
avg_vsd <- rowMeans(assay(vsd))
df <- data.frame(Variance=var_vsd, Mean=avg_vsd)
# plot close to variance==0 with inset:
p1 <- ggplot(df, aes(x=Variance, y=Mean)) +
  geom_point(alpha=0.05)
p2 <- ggplot(df, aes(x=Variance, y=Mean)) +
  geom_point(alpha=0.1) + xlim(0,0.1) + ylim(5,15) +
  theme(panel.background = element_rect(fill='grey90'))
p1 + annotation_custom(ggplotGrob(p2),
                       xmin=7, xmax=15,
                       ymin=10, ymax=25)
```

Some genes have very low variance (which is the whole point of the `vst` transformation), but none of them are zero.
There seems to be little point in drawing an arbitrary threshold, so I move on with the whole dataset.

## 2.2 PCA plot

```{r}
pca <- prcomp(t(assay(vsd)), center=TRUE)
scores <- data.frame(targets$sampleIDs, pca$x[,1:2])
xtitle <- paste0('**PC1** (', round(summary(pca)$importance['Proportion of Variance','PC1']*100,1), ' %)')
ytitle <- paste0('**PC2** (', round(summary(pca)$importance['Proportion of Variance','PC2']*100,1), ' %)')
ptitle <- 'Principal component scores' 
stitle <- '(*vst* pseudocounts, batch-corrected)'

ggplot(scores,
       aes(x = PC1, y = PC2,
           label=factor(targets$sampleIDs),
           colour=factor(targets$condition_md) )
       ) +
  # data
  geom_vline(xintercept=0, linetype='dashed', colour='grey60', linewidth=0.5) +
  geom_hline(yintercept=0, linetype='dashed', colour='grey60', linewidth=0.5) +
  geom_point(size=4) +
  geom_point(size=2, colour='white', alpha=0.5) + 
  geom_text_repel(size=4, alpha=0.75,
                  max.overlaps=Inf,
                  seed=42,
                  force=0.3, force_pull=1, 
                  box.padding=1, point.padding=0.5) +
  lims(x= c(-100, 150), y = c(-80, 80)) +
  # decorations
  theme_minimal(base_size=16) +
  labs(x=xtitle,
       y=ytitle,
       title=ptitle,
       subtitle=stitle) +
  scale_colour_discrete(name="condition") +
  theme(legend.text = element_markdown(size=10),
        axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        plot.title = element_text(hjust=0.5),
        plot.subtitle = element_markdown(hjust=0.5, color="grey40"),
        axis.text.x = element_text(color="grey60"),
        axis.text.y = element_text(color="grey60"),
        axis.ticks.x = element_line(linewidth=0.5, linetype = "solid", color="grey60"),
        axis.ticks.y = element_line(linewidth=0.5, linetype = "solid", color="grey60"),
        axis.ticks.length=unit(-0.25, "cm"),
        panel.border = element_rect(linewidth=1, linetype = "solid", fill = NA),
        panel.grid = element_blank())

ggsave('PCA_vsd_batchcorr.pdf', plot = last_plot(), device = 'pdf',
       path = figdir, dpi = 300)
```


# 3 RNAseq results visualisation: Euler diagrams


# 3.1 Prepare data

```{r load-dge}
# experimental design and labels
targets <- readRDS('output/targets.RDS')
# DEG data
DaDaOE_deg <- readRDS('output/Control_vs_DaDaOE.RDS')
DaKD_deg <- readRDS('output/Control_vs_DaKD.RDS')
DaOE_deg <- readRDS('output/Control_vs_DaOE.RDS')
ScOE_deg <- readRDS('output/Control_vs_ScOE.RDS')
# gene symbols
dlist <- read.table(file="resources/gene_symbols.txt", header=TRUE)
names(dlist)[[1]] <- 'ensembl_gene_id'
rownames(dlist) <- dlist$ensembl_gene_id
```


Now, for each condition, we will need to get the lists of misregulated genes for a given threshold of fold change:
```{r extract_regulated_sets, warning = FALSE}
list_of_degs <- list(DaKD_deg, DaOE_deg, DaDaOE_deg, ScOE_deg)
names_degs <- list(
  as.character(targets[targets$Condition=='DaKD','condition_md'][[1]]),
  as.character(targets[targets$Condition=='DaOE','condition_md'][[1]]),
  as.character(targets[targets$Condition=='DaDaOE','condition_md'][[1]]),
  as.character(targets[targets$Condition=='ScOE','condition_md'][[1]])
  )
regs <- extract_regulated_sets(list_of_degs, names_degs, fc_thresh=1.5)
head(regs,2)
```

Now we need to turn this into logicals:
```{r extract_up|down}
upreg   <- get_deg_logical(regs,'up')
downreg <- get_deg_logical(regs,'down')
```


# 3.2 Plot diagrams


Using instructions from the [vignette](https://cran.r-project.org/web/packages/eulerr/vignettes/introduction.html):
```{r euler_plots, results='hide'}
up_colours <- c(
  brewer.pal(9,'BrBG')[3],   # daRNAi   brown
  brewer.pal(9,'YlOrBr')[4], # daOVEX   yellow/orange
  brewer.pal(9,'Reds')[5],   # dadaOVEX red
  brewer.pal(9,'PuRd')[3]    # scOVEX   violet
)
down_colours <- c(
  brewer.pal(11,'PRGn')[8],  # daRNAi   green
  brewer.pal(11,'RdYlBu')[8], # daOVEX   pale blue
  brewer.pal(11,'RdBu')[9],  # dadaOVEX blue
  brewer.pal(9,'Purples')[5]     # scOVEX   purple
)
upfit <- euler(upreg, loss = 'region', loss_aggregator = 'max')
downfit <- euler(downreg, loss = 'region', loss_aggregator = 'max')
upplot <- plot(upfit,
               fill = up_colours,
               quantities = TRUE)
downplot <- plot(downfit,
                 fill = down_colours,
                 quantities = TRUE)
# save it
pdf(file=paste0(figdir,'/euler_up.pdf'),
     width=10, height=12)
upplot
dev.off()

pdf(file=paste0(figdir,'/euler_down.pdf'),
     width=10, height=12)
downplot
dev.off()

print(upplot)
print(downplot)
```


# 4 RNAseq results visualisation: MA plots


# 4.1 Prepare data

```{r}
```




# 4.2 Plot diagrams







---





---




1 Getting ready


### 1.1 Load the DGE data

This gets us the DGE data from `DESeq2`, identified by FlyBase/Ensembl ID and gene symbol:
```{r load_DEG_data}
# experimental design and labels
targets <- readRDS('output/targets.RDS')
# DEG data
DaKD_deg <- readRDS('output/Control_vs_DaKD.RDS')
DaOE_deg <- readRDS('output/Control_vs_DaOE.RDS')
DaDaOE_deg <- readRDS('output/Control_vs_DaDaOE.RDS')
ScOE_deg <- readRDS('output/Control_vs_ScOE.RDS')
head(ScOE_deg, 1)
```

As discussed previously, we do not really need TPM values here, as the `baseMean` from the `DESeq2` normalisation does the work just as well and is more 'internally consistent'.

Now make a data frame with the status of each gene (up/down/non-regulated) for each condition:
```{r extract_regulated_sets2, warning=FALSE}
# classify genes as up-, down- or non-regulated by padj and fold change threshold
list_of_degs <- list('kd'=DaKD_deg, 'da'=DaOE_deg,
                     'dada'=DaDaOE_deg, 'sc'=ScOE_deg)
names_degs <- list('DaKD','DaOE','DaDaOE','ScOE')
cols.oi <- c('log2FoldChange', 'padj', 'baseMean',
             'gene_symbol', 'ensemblGeneID')
fc_thresh <- 1.5
regs <- extract_regulated_sets2(list_of_degs, names_degs, fc_thresh=fc_thresh, cols=cols.oi)

# attach the results to the DEG data frame for each condition
DaKD_deg$reg <- regs$DaKD
DaOE_deg$reg <- regs$DaOE
DaDaOE_deg$reg <- regs$DaDaOE
ScOE_deg$reg <- regs$ScOE
```

### 1.2 Select genes of interest

To create a list of genes of interest to track their individual expression in the different conditions, I am going to use a list of `genes_of_interest`, manually curated by JdN from the literature (including the Fly Cell Atlas paper) for a simplified cell type classification (ISC, EB, EE, EC, focused on the posterior midgut) and the markers defined by the Fly Cell Atlas consortium. Then I will remove redundancy and simplify the cell type classification.

- First make our list.

```{r load_GOI, message=FALSE}
genes_of_interest <- read_excel('resources/genes_of_interest.xlsx', sheet='core') %>%
  dplyr::select(gene_symbol, bonafide_celltype) %>%
  filter(bonafide_celltype != 'NA') %>%
  rename(celltype = bonafide_celltype) %>%
  group_by(celltype) %>%
  summarise(gene_symbol=paste(gene_symbol, collapse=', '))
```

- Then the FCA markers.

```{r loadFCA, message=FALSE}
markers <- read_xlsx(file.path(getwd(), 'resources', 'science.abk2432_table s2.xlsx')) %>%
  # get only the gut epithelium/muscle cell types
  filter(Tissue=='gut' | `Annotation...1`=='enteroendocrine cell') %>%
  # remove a hybrid/transitional cell type
  filter(!str_detect(`Annotation...1`, 'differentiating')) %>%
  # remove muscle/artefact cells
  filter(!str_detect(`Broad annotation`, 'muscle|artefact')) %>%
  # get just the columns with marker names
  dplyr::select(contains(c('Annotation...1', 'Marker'))) %>%
  # join all markers in a new column
  unite(gene_symbol, contains('Markers'), sep = ', ')
names(markers)[[1]] <- 'celltype'
```

- An merge the two:

```{r merge_markers, message=FALSE}
missd.spelld <- c(`wntD, `='', `LManIV, `='', `CG31269, `='', `CG43208, `='', `orcokinin B, `='',
                   AstB='Mip', poxn='Poxn')
markers <- rbind(genes_of_interest, markers) %>%
  # merge same cell type markers
  group_by(celltype) %>%
  summarise(gene_symbol=paste(gene_symbol, collapse=', ')) %>%
  # correct difference in synonym/capitalisation with DEG data...
  # ... while all gene symbols are in one string
  mutate(gene_symbol = str_replace_all(gene_symbol, missd.spelld)) %>%
  # make each gene name an independent string
  rowwise() %>% mutate(markers = list(unique(str_split(gene_symbol, ', ')[[1]])))
head(markers)
```

- Filter out the genes that do not have unique mapping to a cell type.

```{r filter_markers, message=FALSE}
# filter by exclusivity, but keeping what is common to all enterocytes
## first identify all EC markers
ECmarkers <- markers %>%
  filter(str_detect(celltype, 'enterocyte')) %>%
  dplyr::select(markers) %>%
  unlist(use.names = FALSE) %>%
  unique() %>% as.list()
## then non-EC cell markers, with all their repetitions!!
nonECmarkers <- markers %>%
  filter(!str_detect(celltype, 'enterocyte')) %>%
  dplyr::select(markers) %>%
  unlist(use.names = FALSE) %>% as.list()
## get all markers with one occurrence (≠unique!)
repmarkers <- unlist(c(ECmarkers, nonECmarkers))
reps <- rle(sort(repmarkers))
xmarkers <- reps$values[reps$lengths==1]
## apply criterion of exclusivity
exclude <- function(x) x[x %in% xmarkers]
markers <- markers %>%
    mutate(exclusive = list(exclude(markers)))
pmgcelltypes <- c('intestinal stem cell', 'enteroblast', 'enteroendocrine cell', 'enterocyte of posterior adult midgut epithelium')
pmg.markers <- markers %>%
  filter(celltype %in% pmgcelltypes) %>%
  dplyr::select(c(1,4)) %>%
  rename(xmarkers = exclusive)
```

- Add cell type colours HEX codes

```{r colour_markers}
write_xlsx(unnest_longer(pmg.markers, xmarkers) %>%
    rename(gene_symbol = xmarkers),
    path = 'output/preliminary_Table S4.xlsx')
cellcolours <- c('EB'='#56B2E9', 'EC'='#009E73', 'EE'='#CC79A7', 'ISC'='#D55E00')
pmg.markers$cellcolour <- cellcolours
```


## 2 MA plots using `ggpubr::ggmaplot` wrappers


MA plot for *daughterless* knockdown:
```{r ggmaplot2_da_knockdown}
repulsion <- list(box.padding = 0.1,
                  point.padding = 0.8,
                  nudge_x = 3,
                  nudge_y = 2,
                  force = 1,
                  force_pull = 0,
                  seed.up = 42,
                  seed.dn = 50,
                  xlims.up = c(14, NA),
                  ylims.up = c(5, NA),
                  xlims.dn = c(18, NA),
                  ylims.dn = c(NA, -1))

ggmaplot2(deg = DaKD_deg,
          fc_thresh = fc_thresh,
          markers = pmg.markers,
          md_label = '*esg > da^RNAi^*',
          repulsion = repulsion)
```

Now with cell type-specific colours:
```{r ggmaplot3_da_kd}
repulsion <- list(box.padding = 0.08,
                  point.padding = 0.1,
                  nudge_x = 0,
                  nudge_y = 0,
                  force = 1,
                  force_pull = -0.004,
                  seed.up = 42,
                  seed.dn = 5,
                  xlims.up = c(12, NA),
                  ylims.up = c(5.5, NA),
                  xlims.dn = c(16, NA),
                  ylims.dn = c(NA, -1))

ggmaplot3(deg = DaKD_deg,
          fc_thresh = fc_thresh,
          markers = pmg.markers, 
          md_label = '*esg > da^RNAi^*',
          repulsion = repulsion)


suppressMessages(ggsave('MA_daKD.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```
  
```{r ggmaplot3_da_overexpression}
repulsion <- list(box.padding = 0.1,
                  point.padding = 0.1,
                  force = 1.5,
                  force_pull = -0.003,
                  nudge_x.up = 0,
                  nudge_y.up = 0,
                  nudge_x.dn = 0,
                  nudge_y.dn = 0,
                  seed.up = 42,
                  seed.dn = 5,
                  xlims.up = c(12, NA),
                  ylims.up = c(5, NA),
                  xlims.dn = c(16, NA),
                  ylims.dn = c(NA, -1))

ggmaplot3(deg = DaOE_deg,
          fc_thresh = fc_thresh,
          markers = pmg.markers, 
          md_label = '*esg > da*',
          repulsion = repulsion)

suppressMessages(ggsave('MA_daOE.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```

To the Daughterless homodimer overexpression:
```{r ggmaplot2_da:da_overexpression}
repulsion <- list(box.padding = 0.01,
                  point.padding = 0.1,
                  nudge_x = 0,
                  nudge_y = 0,
                  force = 1,
                  force_pull = -0.004,
                  seed.up = 42,
                  seed.dn = 5,
                  xlims.up = c(16, NA),
                  ylims.up = c(3, NA),
                  xlims.dn = c(16, NA),
                  ylims.dn = c(NA, -2))

ggmaplot3(deg = DaDaOE_deg,
          fc_thresh = fc_thresh,
          markers = pmg.markers, 
          md_label = '*esg > da:da*',
          repulsion = repulsion)

suppressMessages(ggsave('MA_dadaOE.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```

And, finally, to the *scute* overexpression:
```{r ggmaplot2_sc_overexpression}
repulsion <- list(box.padding = 0.01,
                  point.padding = 0.1,
                  nudge_x = 0,
                  nudge_y = 0,
                  force = 0.7,
                  force_pull = -0.003,
                  seed.up = 42,
                  seed.dn = 5,
                  xlims.up = c(8, NA),
                  ylims.up = c(7, NA),
                  xlims.dn = c(8, NA),
                  ylims.dn = c(NA, -6))

ggmaplot3(deg = ScOE_deg,
          fc_thresh = 2,
          markers = pmg.markers,
          md_label = '*esg > scute*',
          repulsion = repulsion)

suppressMessages(ggsave('MA_ScOE.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```


## 3 Heatmap of individual genes


```{r}
tidy.markers <- pmg.markers %>% unnest_longer(xmarkers) %>%
  rename(gene_symbol = xmarkers)

DaKD_deg$condition <- '*da^RNAi^*'
DaOE_deg$condition <- '*da*'
DaDaOE_deg$condition <- '*da:da*'
ScOE_deg$condition <- '*scute*'
genehm.df <- bind_rows(ScOE_deg, DaDaOE_deg, DaOE_deg, DaKD_deg) %>%
  dplyr::select(ensemblGeneID, gene_symbol, log2FoldChange, padj, condition) %>%
  rename(p.adjust = padj) %>%
  filter(gene_symbol %in% tidy.markers$gene_symbol) %>%
  merge(., tidy.markers, by = 'gene_symbol') %>%
  mutate(condition = factor(condition, levels=c("*scute*", "*da:da*", "*da*", "*da^RNAi^*")))
```


```{r, fig.width=20}
p <- layer.heatmaph(genehm.df, arr='celltype')
p + geom_hline(aes(yintercept=3.5), linewidth = 0.5) +
  theme(plot.margin = margin(r = 25))
```

```{r, fig.width=20}
p <- layer.heatmaph(genehm.df, cluster=TRUE)
p + geom_hline(aes(yintercept=3.5), linewidth = 0.5) +
  theme(plot.margin = margin(r = 25))
```


```{r, fig.height = 20}
p <- layer.heatmapv(genehm.df, cluster=TRUE)
p + geom_vline(aes(xintercept=3.5), linewidth = 0.5)
suppressMessages(ggsave('marker_heatmap.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```

```{r}
Espl.df <- bind_rows(ScOE_deg, DaDaOE_deg, DaOE_deg, DaKD_deg) %>%
  dplyr::select(ensemblGeneID, gene_symbol, log2FoldChange, padj, condition) %>%
  rename(p.adjust = padj) %>%
  filter(grepl("^E\\(spl\\)", gene_symbol)) %>%
  mutate(condition = factor(condition, levels=c("*scute*", "*da:da*", "*da*", "*da^RNAi^*"))) %>%
  mutate(cellcolour = "#000000")

p <- layer.heatmapv(Espl.df, cluster=TRUE)
p + geom_vline(aes(xintercept=3.5), linewidth = 0.5)
suppressMessages(ggsave('Esplit_heatmap.pdf', plot = last_plot(), device = 'pdf',
                        path = figdir, dpi = 300))
```
